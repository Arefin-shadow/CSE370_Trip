<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Businesses</title>
    <style>
        /* Common Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        /* Business List Styles */
        .business-list {
            list-style: none;
            padding: 0;
        }

        .business-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .business-item:last-child {
            border-bottom: none;
        }

        .business-info {
            flex: 1;
        }

        .business-info h2 {
            margin: 0;
            font-size: 18px;
            color: #555;
        }

        .business-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #777;
        }

        .delete-button {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .delete-button:hover {
            background: #c0392b;
        }

        /* Add Business Form Styles */
        .add-business-form {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #fdfdfd;
        }

        .add-business-form input,
        .add-business-form textarea,
        .add-business-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .add-business-form button {
            padding: 10px 20px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .add-business-form button:hover {
            background: #27ae60;
        }

        .message {
            text-align: center;
            margin: 20px 0;
            font-size: 16px;
            color: #555;
        }
        .message {
            text-align: center;
            margin: 20px 0;
            font-size: 16px;
            color: #555;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .button-container button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .button-container button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-container">
            <button id="homeButton">Home</button>
            <button id="logoutButton">Logout</button>
        </div>
        <h1>My Businesses</h1>
        <p id="message" class="message"></p>

        <!-- List of Businesses -->
        <ul id="businessList" class="business-list">
            <!-- Business items will be dynamically injected here -->
        </ul>

        <!-- Add Business Form -->
        <div class="add-business-form">
            <h2>Add a New Business</h2>
            <form id="addBusinessForm">
                <input type="text" id="businessName" placeholder="Business Name" required />
                <textarea id="businessDescription" placeholder="Business Description" rows="4"></textarea>
                <input type="number" id="businessRating" placeholder="Rating (1-5)" min="1" max="5" />
                <select id="businessType" required>
                    <option value="" disabled selected>Select Business Type</option>
                    <option value="hotel">Hotel</option>
                    <option value="restaurant">Restaurant</option>
                </select>
                <input type="text" id="businessLocation" placeholder="Location Name" required />
                <button type="submit" id="submit" value="add">Add Business</button>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token'); // Get JWT token from localStorage

        // Fetch user's businesses
        async function fetchBusinesses() {
            try {
                const response = await fetch('http://localhost:8081/business/getUserBusinesses', {
                    method: 'GET',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    displayBusinesses(data.businesses);
                } else {
                    document.getElementById('message').textContent = data.message || 'Failed to fetch businesses.';
                }
            } catch (error) {
                document.getElementById('message').textContent = 'Error fetching businesses.';
                console.error(error);
            }
        }

        // Display businesses in the list
        function displayBusinesses(businesses) {
            const businessList = document.getElementById('businessList');
            businessList.innerHTML = ''; // Clear the list

            if (businesses.length === 0) {
                document.getElementById('message').textContent = 'You do not own any businesses yet.';
                return;
            }

            businesses.forEach((business) => {
                const listItem = document.createElement('li');
                listItem.className = 'business-item';

                const businessInfo = document.createElement('div');
                businessInfo.className = 'business-info';
                businessInfo.innerHTML = `
                    <h2>${business.name}</h2>
                    <p>${business.description}</p>
                    <p><strong>Type:</strong> ${business.serviceType}</p>
                    <p><strong>Rating:</strong> ${business.rating || 'N/A'}</p>
                `;

                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteBusiness(business.serviceID);

                listItem.appendChild(businessInfo);
                listItem.appendChild(deleteButton);
                businessList.appendChild(listItem);
            });
        }

        // submit request for deleting a business
        async function deleteBusiness(serviceID) {
            try {
                const response = await fetch(`http://localhost:8081/business/deleteRequest/${serviceID}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message || 'Business deleted successfully.');
                    fetchBusinesses(); // Refresh the list
                } else {
                    alert(data.message || 'Failed to delete the business.');
                }
            } catch (error) {
                alert('Error deleting the business.');
                console.error(error);
            }
        }


        // Add a new business (send request for admin approval first)
        async function addBusiness(e) {
            e.preventDefault();

            const name = document.getElementById('businessName').value;
            const description = document.getElementById('businessDescription').value;
            const rating = document.getElementById('businessRating').value;
            const serviceType = document.getElementById('businessType').value;
            const locationName = document.getElementById('businessLocation').value;
            const action = document.getElementById('submit').value;

            requestBody = {
                name,
                description,
                rating,
                serviceType,
                locationName,
            }

            try {
                const response = await fetch('http://localhost:8081/business/addRequest', {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({action, requestBody}),
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message || 'Business added successfully.');
                    document.getElementById('addBusinessForm').reset(); // Clear the form
                    fetchBusinesses(); // Refresh the list
                } else {
                    alert(data.message || 'Failed to add the business.');
                }
            } catch (error) {
                alert('Error adding the business.');
                console.error(error);
            }
        }

        // Attach form submission handler
        document.getElementById('addBusinessForm').addEventListener('submit', addBusiness);

        // Initial fetch of businesses
        fetchBusinesses();
        document.getElementById('homeButton').addEventListener('click', () => {
            window.location.href = '../Landing Page/landing.html';
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.replace('../Signup/registration.html');
        });
    </script>
</body>
</html>
